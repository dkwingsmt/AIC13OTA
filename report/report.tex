%# -*- coding: utf-8 -*-
\documentclass[a4paper]{article}
\usepackage{graphicx}
\usepackage{epstopdf}
\usepackage{pstool}
\usepackage{titlesec, titletoc}     %设置标题格式
%\usepackage{CJKnumb}               %中文数字
\usepackage[unicode=true,
            CJKbookmarks=true,
            colorlinks=true,
            linkcolor=black]{hyperref}
\usepackage[noindent,nocap,nopunct,space]{ctex}
\usepackage{wrapfig}
\usepackage{fancyhdr}   %页眉页脚
\usepackage{ifthen}
\usepackage{longtable}
\usepackage{listings}               %代码排版
\usepackage{color}                  %代码排版背景颜色
\usepackage[labelfont=bf,up,
            textfont=it,up]{caption}
\usepackage{subcaption}
\usepackage{amsmath}
\usepackage{makecell}
\usepackage[americanvoltages,americancurrents,americanresistors,%
    americaninductors,americanports,siunitx,emptydiodes,%
  arrowmos,nopmosdot]{circuitikz}
\usepackage{tikz}
\usepackage{siunitx}
\usepackage{multirow}

\definecolor{gray}{rgb}{0.9,0.9,0.9}
\definecolor{shadecolor}{gray}{0.85}

%\usepackage[autolinebreaks]{mcode}
\lstset{aboveskip=.8em,
xleftmargin=1em,
xrightmargin=1em,
language={},
basicstyle=\footnotesize\ttfamily,
backgroundcolor=\color{gray},
}

%设置各字体
\setCJKmainfont[BoldFont={FZDaHei-B02S},
    ItalicFont={Adobe Kaiti Std}]{Adobe Song Std}
\setCJKmonofont{Adobe Fangsong Std}
\setmainfont[Mapping=tex-text]{Times New Roman}
\setsansfont{Arial}
\setmonofont{Courier New}

\newcommand{\HUGE}{\fontsize{29pt}{29pt}\selectfont}

%\titleformat{\contents}{\Huge\bfseries}{\vspace{0.3cm}}{1em} {}
%\titleformat{\section}{\centering\fontsize{16pt}{20pt}\selectfont\bfseries}{\vspace{0.3cm}}{1em} {\vspace{.8cm}}
%\titleformat{\subsection}{\fontsize{12pt}{15pt}\selectfont\bfseries}{\arabic{subsection}.}{1em} {}
%\titleformat{\subsubsection}{\large\bfseries}{\arabic{subsection}.\arabic{subsubsection}}{1em} {\vspace{.1em}}

\headheight=13pt

% 本文档自定义变量

\renewcommand{\d}[1]{\ensuremath{\operatorname{d}\!{#1}}}

\newcommand{\lsq}{\ensuremath{\protect{[}}}
\newcommand{\rsq}{\ensuremath{\protect{]}}}

%\renewcommand{\d}{\ensuremath{{d}}}
\newcommand{\uV}{\si{\volt}}
\newcommand{\umV}{\si{\milli\volt}}
\newcommand{\uuV}{\si{\micro\volt}}

\newcommand{\umA}{\si{\milli\ampere}}
\newcommand{\uuA}{\si{\micro\ampere}}

\newcommand{\upF}{\si{\pico\farad}}
\newcommand{\ufF}{\si{\femto\farad}}
\newcommand{\unF}{\si{\nano\farad}}

\newcommand{\upJ}{\si{\pico\joule}}

\newcommand{\unm}{\si{\nano\metre}}
\newcommand{\uum}{\si{\micro\metre}}
\newcommand{\uumsq}{\si{\micro\metre^2}}

\newcommand{\uns}{\si{\nano\second}}
\newcommand{\ups}{\si{\pico\second}}

\newcommand{\uuW}{\si{\micro\watt}}
\newcommand{\umW}{\si{\milli\watt}}

\newcommand{\uO}{\si{\ohm}}
\newcommand{\ukO}{\si{\kilo\ohm}}

\newcommand{\uS}{\si{\siemens}}
\newcommand{\umS}{\si{\milli\siemens}}

\newcommand{\uPV}{\si{\volt^{-1}}}
\newcommand{\uAPV}{\si{\ampere\per\volt}}
\newcommand{\umAPV}{\si{\milli\ampere\per\volt}}

\newcommand{\uHz}{\si{\hertz}}
\newcommand{\uMHz}{\si{\mega\hertz}}
\newcommand{\ukHz}{\si{\kilo\hertz}}

\newcommand{\udB}{\si{\deci\bel}}
\newcommand{\uVVPHz}{\si{\volt^2\per\hertz}}

\newcommand{\udeg}{\si{\degree}}

\newcommand{\ten}[1]{\ensuremath{\times10^{#1}}}

\newcommand{\dM}[1]{\mathrm{M}_\mathrm{#1}}
\newcommand{\DM}[1]{$\dM{#1}$}
\newcommand{\dR}[1]{\mathrm{R}_\mathrm{#1}}
\newcommand{\DR}[1]{$\dR{#1}$}
\newcommand{\dC}[1]{\mathrm{C}_\mathrm{#1}}
\newcommand{\DC}[1]{$\dC{#1}$}


%% circuitikz 
\makeatletter
\ctikzset{lx/.code args={#1 and #2}{ 
  \pgfkeys{/tikz/circuitikz/bipole/label/name=\parbox{1cm}{\centering #1  \\ #2}}
    \ctikzsetvalof{bipole/label/unit}{}
    \ifpgf@circ@siunitx 
        \pgf@circ@handleSI{#2}
        \ifpgf@circ@siunitx@res 
            \edef\pgf@temp{\pgf@circ@handleSI@val}
            \pgfkeyslet{/tikz/circuitikz/bipole/label/name}{\pgf@temp}
            \edef\pgf@temp{\pgf@circ@handleSI@unit}
            \pgfkeyslet{/tikz/circuitikz/bipole/label/unit}{\pgf@temp}
        \else
        \fi
    \else
    \fi
}}

\ctikzset{lx^/.style args={#1 and #2}{ 
    lx=#2 and #1,
    \circuitikzbasekey/bipole/label/position=90 } 
}

\ctikzset{lx_/.style args={#1 and #2}{ 
    lx=#1 and #2,
    \circuitikzbasekey/bipole/label/position=-90 } 
}
\makeatother

%% External resources
\input{gmid_i.tex}
\input{mos_sizes.tex}
\newcommand{\moslabel}[3]{\shortstack{$\dM{#1}$\\{\scriptsize$#2$}\\{\scriptsize$#3$}}}

\begin{document}

\begin{titlepage}

% 首行的位置往上调整。但vspace前面需要有东西才会起效。
\phantom{Start!}
\vspace{-1.7cm}

\begin{flushleft}

\emph{\Large 清华大学微纳电子系}\\[0.2cm]
\emph{\Large 模拟集成电路分析与设计}\\[4.2cm]     % 课程

% Title
{ \HUGE \bfseries OTA放大器设计}\\[0.4cm]    % 主标题
{ \huge \bfseries 设计报告}             % 副标题

\end{flushleft}

\vfill

\begin{flushright}

{
\newcommand{\pillar}{ {\Huge \phantom{A}} } %一种统一的方法提高行高
\large \begin{tabular}{lll}
  \pillar 姓名 & 孙泽雷 & 2010011210 \\
  \pillar&牟瞳 & 2010011204          \\
  \pillar&吕若辰 & 2010011201        \\
  \pillar 班级 & 微02 &               \\
  \pillar 报告日期 & \multicolumn{2}{l}{2013年6月28日}  \\
\end{tabular}
}

\end{flushright}

\end{titlepage}

\newpage

\pagenumbering{arabic}
\pagestyle{fancy}
\fancyhead{}    % 清空设置
\fancyhead[HL]{清华大学电子工程系}
\fancyhead[HR]{数字逻辑与处理器基础实验}    %课程

% Page 1: Outline of your design, justifications of key design decisions; 
% comparison with alternatives.

\section{综述}

本电路设计了一个低功耗OTA放大器。

采用的基本电路是Telescope单级放大器，它的优点是在具有较大增益的同时，
功耗较低。其缺点是比起折叠Cascode放大器而言摆幅较低，从而导致动态增益
的目标会更难完成，不过由于本次设计目标中动态增益的要求还算适中，
为了达到更低功耗的目的，仍采用Telescope放大电路。设计的过程也表明，
设计时的主要限制因素并非动态增益（而是静态误差和动态时间之间的折衷）。

采用了基于理想压控电流源的共模反馈，共模基准电压为$1.6\uV$。

\newpage

\section{电路结构及参数}

% Page 2: Schematic diagram of final design, with component values and bias 
% currents clearly labeled. Show component values right next to the components, 
% and currents next to the branches (i.e., absolutely, positively do not make us 
% refer to a look-up table). Annotate all transistors with the chosen gm/ID value.
\subsection{Telescopic电路结构}
Telescopic电路图及各项器件的参数如图\ref{circuit}。

图中采用简单镜像电流源对 Telescopic 的支路电流进行偏置。
\begin{figure}[htb!]
  \centering
  \input{circuit.tex}
  \caption{最终电路结构及参数}
  \label{circuit}
\end{figure}
\subsection{差分负反馈电路}
为克服 PVT 变化对电路性能的影响,降低增益的灵敏度,扩展带宽,提高线性度等一系列原因本电路采用差分负反馈电路。本实验差分负反馈电路如图所示。【图片，差分负反馈】
\subsection{共模反馈电路}
共模反馈的电路结构如图所示,主要起到稳定共模输出点的作用,使输出共模点稳定在【数值】左右。【图片，共模反馈电路】

\newpage

% Pages 3-5: Calculation of key design parameters, such as transconductances, 
% bias currents, etc.  Be sure to include a calculation of the circuit’s settling 
% time. Compare hand calculated values with final HSpice values in a table and 
% discuss discrepancies. Make sure to include the total power dissipation of your 
% design (calculation and HSpice). 
% This is one of the most important sections of your report! The lowest power 
% designs will not automatically score the highest grades. The methodology you 
% used to justify your design choices and component values is far more important 
% (see section on point distribution below).

\section{设计过程}
\subsection{准备工作}
首先，我们使用电路测量了所使用晶体管的几条特征曲线，详细说明如表\ref{finds}。
\begin{table}
  \begin{center}
    \begin{tabular}{ccc}
      测量内容 & 文件 & 备注 \\\hline
      $g_mr_0$--$f$ & \texttt{findgmr0.sp} & 
            固定$V_D=1\uV$及$V_{ov}=0.2\uV$；在漏极使用大电感来通直隔交 \\
      $g_m/I_D$--$f_t$ & \texttt{findgmid\_ft.sp} &
            固定$V_D=3\uV$    \\
      $g_m/I_D$--$I_D/W$ & \texttt{findgmid\_idw.sp} &
            固定$V_D=3\uV$    
    \end{tabular}
  \end{center}
  \caption{测量特征曲线的详细说明}
  \label{finds}
\end{table}

接下来为了方便调试，将提供的Testbench进行自动化，运行Makefile及\texttt{ota\_sumup.m}
即可运行四个调试并显示所有参数。

\subsection{理论计算}
首先我们完成了电路的拓扑图，但所有的晶体管长宽、$I_B$和共模反馈跨导都没有确定。
由于共模反馈理论上不会影响差模性能，我们将其跨导定为$10\umS$。

为了从理论上推导出计算结果，我们首先需要得到电路设计要求如表\ref{requirements}。
\begin{table}
  \begin{center}
    \begin{tabular}{cc}
      参数 & 要求 \\\hline
      DR & $80\udB$ \\
      $\epsilon_s$ & $0.1\%$ \\
      $\epsilon_d$ & $0.05\%$ \\
      $t_d$ & $10\uns$ \\
    \end{tabular}
  \end{center}
  \caption{电路设计要求}
  \label{requirements}
\end{table}
除了这些数据之外还需要的一些其它数据，我们为其设定一个初始值。
\DM{1,2}的栅级电容与$C_s$的比设定为$k_{C_{g1,2},C_s}=0.5$；
电压输出摆幅设定为$V_{swing}=2\uV$。
相位裕度没有要求，为了达到较好的建立时间应达到$72\udeg$，不过这里暂时设定为
$80\udeg$；沟道电流噪声系数取长沟道$\gamma=2/3$。

最后我们暂时假设所有NMOS和所有PMOS各具有相同的沟道长度。

接下来进入正式计算。首先容易得到的是电容反馈系数
$$\beta=\frac{C_f}{C_f+C_s+C_{g1,2}}$$
为了得到$C_L$和$C_{Ltot}$，通过噪声功率
$$N_{tot}=\frac{V_{swing}^2}{2\times10^{\mathrm{DR}/10}}$$
$$C_{Ltot}=\frac{2kT\gamma}{\beta N_{tot}}$$
$$C_L=C_{Ltot}-(1-\beta)C_f$$
在这里会验证$C_L$是否满足$2\upF$的要求。

接下来通过静态误差得到低频增益的要求
$a_v0=\frac{1}{\epsilon_s\beta}$




\subsection{手工调整}

\newpage

\section{电路性能}
\subsection{AC仿真频率特性}
【图片，AC】
电路幅频曲线，相频曲线如图所示。
可以看到低频闭环增益为，相位裕度为，闭环跨导频率。
% Page 6: Bode plot of T(j), phase and magnitude. Clearly annotate the achieved 
% low frequency loop gain, the loop crossover frequency and the phase margin.
\newpage
\subsection{输出范围}
【图片，DC】
最大差模增益为,70\%的最大增益为,对应的 Vod 的工作点位于,所以输出范围为。
\newpage
\subsection{噪声性能}
【图片，noise】
从图中看到DR为dB,满足性能指标。Telescopic 结构的缺点在于输出摆幅比较小,致使动态范围很难达到要求。但也应注意到噪声小也是其主要优势,通过调节尽可能增大输出摆幅,减小噪声可以提高动态范围。
\newpage
\subsection{瞬态性能}
【图片，transient】两张
通过之前的dc仿真,已经知道输出摆幅约为。设定参数为该值， 在输出满摆幅的情况下,进行时序仿真,静态误差为\%。建立时间为,
满足要求。
\newpage
\subsection{性能总结}
\begin{table}[htbp]
    \begin{tabular}{|c|c|}
        \hline
        dynamic range&\\
        \hline
        phase margin&\\
        \hline
        $f_c$ &\\
        \hline 
        $T_0$&\\
        \hline
        $V_{odmax}$&\\
        \hline
        $t_s$($\varepsilon_s$=0.1\%)&\\
        \hline
        power consumption&\\
        \hline
        $C_l$&\\
        \hline
        $C_s$&\\
        \hline
    \end{tabular}
\end{table}

% Page 7: Plots the simulated settling transient of Vod (no zoom, show the 
% entire waveform). In a separate subplot, show the % error of the differential 
% output voltage relative to the ideal output voltage. Zoom into the relevant 
% region of the settling, i.e. clearly demonstrate that your
% design settles within spec. Annotate the achieved settling time and static 
% settling error. For simplicity, we use the error at t=30ns as an estimate of 
% the static settling error.  


% Page 8: Plot the common mode output voltage versus time during transient 
% settling of the circuit. In separate subplots each, also show the differential 
% output current of the OTA, and the differential input to the OTA (Vid in Figure 1).


% Page 9: Plot of the noise power spectral density at the OTA output (Vod) and 
% noise integral.  Annotate the total integrated noise value and the achieved 
% dynamic range.  

% Page 10: Output range. Simulation plot showing the differential open loop DC 
% gain Vod/Vid of the amplifier. Mark the differential output voltage at which 
% the gain has dropped by 30%.  This value should be larger than the peak output 
% voltage used in your dynamic range calculation.

\newpage
% Page 11-12: Results of corner simulations. Tabulate your circuit’s performance 
% for the slow/hot and fast/cold corner. Include settling time, static error, 
% and any other parameter that you find noteworthy. Include the %-changes with 
% respect to nominal conditions in your table.
% In case the circuit is non-functional in these corners, investigate and explain 
% the problem (no need to fix the circuit). Include selected interesting plots 
% documenting corner performance and/or issues.

\section{slow corner路性能}
\subsection{AC仿真频率特性}
【图片，AC】
电路幅频曲线，相频曲线如图所示。
可以看到低频闭环增益为，相位裕度为，闭环跨导频率。
% Page 6: Bode plot of T(j), phase and magnitude. Clearly annotate the achieved 
% low frequency loop gain, the loop crossover frequency and the phase margin.
\newpage
\subsection{输出范围}
【图片，DC】
输出范围为。输出摆幅比原数据略大。
\newpage
\subsection{噪声性能}
【图片，noise】
从图中看到DR为dB。噪声特性DR变低。
\newpage
\subsection{瞬态性能}
【图片，transient】两张
可以看出静态误差变大，线性建立时间变长。
\newpage
\subsection{性能总结}
\begin{table}[htbp]
    \begin{tabular}{|c|c|}
        \hline
        dynamic range&\\
        \hline
        phase margin&\\
        \hline
        $f_c$ &\\
        \hline 
        $T_0$&\\
        \hline
        $V_{odmax}$&\\
        \hline
        $t_s$($\varepsilon_s$=0.1\%)&\\
        \hline
        power consumption&\\
        \hline
        $C_l$&\\
        \hline
        $C_s$&\\
        \hline
    \end{tabular}
\end{table}

\newpage

\section{fast corner路性能}
\subsection{AC仿真频率特性}
【图片，AC】
电路幅频曲线，相频曲线如图所示。
可以看到低频闭环增益为，相位裕度为，闭环跨导频率。
可以发现负反馈增益和带宽有相互抑制的关系。
% Page 6: Bode plot of T(j), phase and magnitude. Clearly annotate the achieved 
% low frequency loop gain, the loop crossover frequency and the phase margin.
\newpage
\subsection{输出范围}
【图片，DC】
%\begin{figure}[htb]
%    \begin{center}
%        \includegraphics[width=\textwidth]{....pdf}
%    \end{center}
%    \caption{DC图}
%    \label{dc}
%\end{figure}
%\ref{dc}
输出范围为。输出摆幅比原数据略。
\newpage
\subsection{噪声性能}
【图片，noise】
从图中看到DR为dB。噪声特性DR变。
\newpage
\subsection{瞬态性能}
【图片，transient】两张
可以看出静态误差变，线性建立时间变。
\newpage
\subsection{性能总结}
\begin{table}[htbp]
    \begin{tabular}{|c|c|}
        \hline
        dynamic range&\\
        \hline
        phase margin&\\
        \hline
        $f_c$ &\\
        \hline 
        $T_0$&\\
        \hline
        $V_{odmax}$&\\
        \hline
        $t_s$($\varepsilon_s$=0.1\%)&\\
        \hline
        power consumption&\\
        \hline
        $C_l$&\\
        \hline
        $C_s$&\\
        \hline
    \end{tabular}
\end{table}


% Page 13: Comments and Conclusion. Here, you can convey issues you may have had, 
% or things you’ve learned/not learned in this project.
\section{结论与总结}
本次project使我对OTA设计有了更深的理解。书本上轻描淡写几笔带过的设计流程，
在实际设计中却有着复杂而错综复杂的关联关系。从前期对电路结构的选择，到最终
选择Telescopic结构，对于不同OTA的特点有了更深的理解。集成了手工计算，
matlab仿真，以及后期调整迭代的project，使我们对于设计流程有了更
深入的体会。并且对各个参数指标之间的关系进行了思考和分析，整理了这些互相交织的概念
。通过对课本基本两级 OTA 的设计案例的分析,参照其流程和思路,我们
经过多次修改和调试完成了本次课程设计。在调试和修改的过程中,我感触最深刻的
是电路性能之间的互相关联以及为达到设计指标所做出的折衷。为了换得到较小的动态误差，
我们相应牺牲了一些相位裕量和并加大了一些功耗。
这样的妥协还有很多，正是在权衡考虑之间，才能更好的设计出满足设计指标的电路。

另外，课程设计中涉及到的电路复杂，结构互相关联。project要求中模块化设计的设计思路,
对于我们很有帮助。各个电路结构成一个个子系统
，电路参数提取时分成一个个小文件，这样可以防止我们在纷多的设计参数中迷乱，
在复杂的电路前束手无策。在分析偏置模块和差分负反馈模块的性能,明确各个管子在电路中的作用,仿真
过程中更有针对性地对关键晶体管反复进行参数修改过程中,模块化设计保证了调试的有效进行。

最后，值得一提的是在本次设计中大量使用了自动化脚本进行数据分析。因为脚本的大量使用，我们可以实现在
命令行中输入一个命令，就可以将调整过设计要求的电路参数自动输出到文件，之后再include进入hspice仿真
完整之后的工作，再一次性完成多个技术参数的提取。通过这样的步骤，大大简化了较为繁琐的手续，可以更加高效的完成
后面的设计。

课程设计汇报时助教候老师提出的建议对我们后续的修改和优化起到了较大的帮助,在这里感谢助教老师。
在整个报告的最后，将感谢献给小组的成员。日日夜夜的奋斗得到的不仅仅是一个project，
更是对于问题的思考，对于困难的无畏，对于更高标准的坚持，对于合作的推崇。很多问题自己琢磨很久没有头绪,
在和大家一起讨论分析之后问题能够逐渐被解决。相信所有的这一切都会成为大家共同的回忆。



\end{document}
