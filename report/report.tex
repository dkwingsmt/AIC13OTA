%# -*- coding: utf-8 -*-
\documentclass[a4paper]{article}
\usepackage{graphicx}
\usepackage{epstopdf}
\usepackage{pstool}
\usepackage{titlesec, titletoc}     %设置标题格式
%\usepackage{CJKnumb}               %中文数字
\usepackage[unicode=true,
            CJKbookmarks=true,
            colorlinks=true,
            linkcolor=black]{hyperref}
\usepackage[noindent,nocap,nopunct,space]{ctex}
\usepackage{wrapfig}
\usepackage{fancyhdr}   %页眉页脚
\usepackage{ifthen}
\usepackage{longtable}
\usepackage{listings}               %代码排版
\usepackage{color}                  %代码排版背景颜色
\usepackage[labelfont=bf,up,
            textfont=it,up]{caption}
\usepackage{subcaption}
\usepackage{amsmath}
\usepackage{makecell}
\usepackage[americanvoltages,americancurrents,americanresistors,%
    americaninductors,americanports,siunitx,emptydiodes,%
  arrowmos,nopmosdot]{circuitikz}
\usepackage{tikz}
\usepackage{siunitx}
\usepackage{multirow}

\definecolor{gray}{rgb}{0.9,0.9,0.9}
\definecolor{shadecolor}{gray}{0.85}

%\usepackage[autolinebreaks]{mcode}
\lstset{aboveskip=.8em,
xleftmargin=1em,
xrightmargin=1em,
language={},
basicstyle=\footnotesize\ttfamily,
backgroundcolor=\color{gray},
}

%设置各字体
\setCJKmainfont[BoldFont={FZDaHei-B02S},
    ItalicFont={Adobe Kaiti Std}]{Adobe Song Std}
\setCJKmonofont{Adobe Fangsong Std}
\setmainfont[Mapping=tex-text]{Times New Roman}
\setsansfont{Arial}
\setmonofont{Courier New}

\newcommand{\HUGE}{\fontsize{29pt}{29pt}\selectfont}

%\titleformat{\contents}{\Huge\bfseries}{\vspace{0.3cm}}{1em} {}
%\titleformat{\section}{\centering\fontsize{16pt}{20pt}\selectfont\bfseries}{\vspace{0.3cm}}{1em} {\vspace{.8cm}}
%\titleformat{\subsection}{\fontsize{12pt}{15pt}\selectfont\bfseries}{\arabic{subsection}.}{1em} {}
%\titleformat{\subsubsection}{\large\bfseries}{\arabic{subsection}.\arabic{subsubsection}}{1em} {\vspace{.1em}}

\headheight=13pt

% 本文档自定义变量

\renewcommand{\d}[1]{\ensuremath{\operatorname{d}\!{#1}}}

\newcommand{\lsq}{\ensuremath{\protect{[}}}
\newcommand{\rsq}{\ensuremath{\protect{]}}}

%\renewcommand{\d}{\ensuremath{{d}}}
\newcommand{\uV}{\si{\volt}}
\newcommand{\umV}{\si{\milli\volt}}
\newcommand{\uuV}{\si{\micro\volt}}

\newcommand{\umA}{\si{\milli\ampere}}
\newcommand{\uuA}{\si{\micro\ampere}}

\newcommand{\upF}{\si{\pico\farad}}
\newcommand{\ufF}{\si{\femto\farad}}
\newcommand{\unF}{\si{\nano\farad}}

\newcommand{\upJ}{\si{\pico\joule}}

\newcommand{\unm}{\si{\nano\metre}}
\newcommand{\uum}{\si{\micro\metre}}
\newcommand{\uumsq}{\si{\micro\metre^2}}

\newcommand{\uns}{\si{\nano\second}}
\newcommand{\ups}{\si{\pico\second}}

\newcommand{\uuW}{\si{\micro\watt}}
\newcommand{\umW}{\si{\milli\watt}}

\newcommand{\uO}{\si{\ohm}}
\newcommand{\ukO}{\si{\kilo\ohm}}

\newcommand{\uS}{\si{\siemens}}
\newcommand{\umS}{\si{\milli\siemens}}

\newcommand{\uPV}{\si{\volt^{-1}}}
\newcommand{\uAPV}{\si{\ampere\per\volt}}
\newcommand{\umAPV}{\si{\milli\ampere\per\volt}}

\newcommand{\uHz}{\si{\hertz}}
\newcommand{\uMHz}{\si{\mega\hertz}}
\newcommand{\ukHz}{\si{\kilo\hertz}}

\newcommand{\udB}{\si{\deci\bel}}
\newcommand{\uVVPHz}{\si{\volt^2\per\hertz}}

\newcommand{\udeg}{\si{\degree}}

\newcommand{\dM}[1]{\mathrm{M}_\mathrm{#1}}
\newcommand{\dR}[1]{\mathrm{R}_\mathrm{#1}}
\newcommand{\dC}[1]{\mathrm{C}_\mathrm{#1}}

%% circuitikz 
\makeatletter
\ctikzset{lx/.code args={#1 and #2}{ 
  \pgfkeys{/tikz/circuitikz/bipole/label/name=\parbox{1cm}{\centering #1  \\ #2}}
    \ctikzsetvalof{bipole/label/unit}{}
    \ifpgf@circ@siunitx 
        \pgf@circ@handleSI{#2}
        \ifpgf@circ@siunitx@res 
            \edef\pgf@temp{\pgf@circ@handleSI@val}
            \pgfkeyslet{/tikz/circuitikz/bipole/label/name}{\pgf@temp}
            \edef\pgf@temp{\pgf@circ@handleSI@unit}
            \pgfkeyslet{/tikz/circuitikz/bipole/label/unit}{\pgf@temp}
        \else
        \fi
    \else
    \fi
}}

\ctikzset{lx^/.style args={#1 and #2}{ 
    lx=#2 and #1,
    \circuitikzbasekey/bipole/label/position=90 } 
}

\ctikzset{lx_/.style args={#1 and #2}{ 
    lx=#1 and #2,
    \circuitikzbasekey/bipole/label/position=-90 } 
}
\makeatother

%% External resources
\input{gmid_i.tex}
\input{mos_sizes.tex}
\newcommand{\moslabel}[3]{\shortstack{$\dM{#1}$\\{\scriptsize$#2$}\\{\scriptsize$#3$}}}

\begin{document}

\begin{titlepage}

% 首行的位置往上调整。但vspace前面需要有东西才会起效。
\phantom{Start!}
\vspace{-1.7cm}

\begin{flushleft}

\emph{\Large 清华大学微纳电子系}\\[0.2cm]
\emph{\Large 模拟集成电路分析与设计}\\[4.2cm]     % 课程

% Title
{ \HUGE \bfseries OTA放大器设计}\\[0.4cm]    % 主标题
{ \huge \bfseries 设计报告}             % 副标题

\end{flushleft}

\vfill

\begin{flushright}

{
\newcommand{\pillar}{ {\Huge \phantom{A}} } %一种统一的方法提高行高
\large \begin{tabular}{lll}
  \pillar 姓名 & 孙泽雷 & 2010011210 \\
  \pillar&牟瞳 & 2010011204          \\
  \pillar&吕若辰 & 2010011201        \\
  \pillar 班级 & 微02 &               \\
  \pillar 报告日期 & \multicolumn{2}{l}{2013年6月28日}  \\
\end{tabular}
}

\end{flushright}

\end{titlepage}

\newpage

\pagenumbering{arabic}
\pagestyle{fancy}
\fancyhead{}    % 清空设置
\fancyhead[HL]{清华大学电子工程系}
\fancyhead[HR]{数字逻辑与处理器基础实验}    %课程

% Page 1: Outline of your design, justifications of key design decisions; 
% comparison with alternatives.

\section{综述}

本电路设计了一个低功耗OTA放大器。

采用的基本电路是Telescope单级放大器，它的优点是在具有较大增益的同时，
功耗较低。其缺点是比起折叠Cascode放大器而言摆幅较低，从而导致动态增益
的目标会更难完成，不过由于本次设计目标中动态增益的要求还算适中，
为了达到更低功耗的目的，仍采用Telescope放大电路。设计的过程也表明，
设计时的主要限制因素并非动态增益（而是静态误差和动态时间之间的折衷）。

采用了基于理想压控电流源的共模反馈，共模基准电压为$1.6\uV$。

\newpage

\section{电路结构及参数}

% Page 2: Schematic diagram of final design, with component values and bias 
% currents clearly labeled. Show component values right next to the components, 
% and currents next to the branches (i.e., absolutely, positively do not make us 
% refer to a look-up table). Annotate all transistors with the chosen gm/ID value.

电路图及各项器件的参数如图\ref{circuit}。
\begin{figure}[htb!]
  \centering
  \input{circuit.tex}
  \caption{最终电路结构及参数}
  \label{circuit}
\end{figure}

\newpage

% Pages 3-5: Calculation of key design parameters, such as transconductances, 
% bias currents, etc.  Be sure to include a calculation of the circuit’s settling 
% time. Compare hand calculated values with final HSpice values in a table and 
% discuss discrepancies. Make sure to include the total power dissipation of your 
% design (calculation and HSpice). 
% This is one of the most important sections of your report! The lowest power 
% designs will not automatically score the highest grades. The methodology you 
% used to justify your design choices and component values is far more important 
% (see section on point distribution below).

\section{设计过程}
\subsection{准备工作}
首先，我们使用电路测量了所使用晶体管的几条特征曲线，详细说明如表\ref{finds}。
\begin{table}
  \begin{center}
    \begin{tabular}{ccc}
      测量内容 & 文件 & 备注 \\\hline
      $g_mr_0$--$f$ & \texttt{findgmr0.sp} & 
            固定$V_D=1\uV$及$V_{ov}=0.2\uV$；在漏极使用大电感来通直隔交 \\
      $g_m/I_D$--$f_t$ & \texttt{findgmid\_ft.sp} &
            固定$V_D=3\uV$    \\
      $g_m/I_D$--$I_D/W$ & \texttt{findgmid\_idw.sp} &
            固定$V_D=3\uV$    
    \end{tabular}
  \end{center}
  \caption{测量特征曲线的详细说明}
  \label{finds}
\end{table}

接下来为了方便调试，将提供的Testbench进行自动化，运行Makefile及\texttt{ota\_sumup.m}
即可运行四个调试并显示所有参数。

\subsection{理论计算}
首先我们完成了电路的拓扑图，但所有的晶体管长宽、$I_B$和共模反馈跨导都没有确定。
由于共模反馈理论上不会影响差模性能，我们将其跨导定为$10\umS$。

为了从理论上推导出计算结果，我们首先需要得到电路设计要求如表\ref{requirements}。
\begin{table}
  \begin{center}
    \begin{tabular}{cc}
      参数 & 要求 \\\hline
      DR & $80\udB$ \\
      $\epsilon_s$ & $0.1\%$ \\
      $\epsilon_d$ & $0.05\%$ \\
      $t_d$ & $10\uns$ \\
    \end{tabular}
  \end{center}
  \caption{电路设计要求}
  \label{requirements}
\end{table}
除了这些数据之外还需要的一些其它数据，我们为其设定一个初始值。
\DM{1,2}的栅级电容与$C_s$的比设定为$k_{C_{g1,2},C_s}=0.5$；
电压输出摆幅设定为$V_{swing}=2\uV$。
相位裕度没有要求，为了达到较好的建立时间应达到$72\udeg$，不过这里暂时设定为
$80\udeg$；沟道电流噪声系数取长沟道$\gamma=2/3$。

最后我们暂时假设所有NMOS和所有PMOS各具有相同的沟道长度。

接下来进入正式计算。首先容易得到的是电容反馈系数
$$\beta=\frac{C_f}{C_f+C_s+C_{g1,2}$$
为了得到$C_L$和$C_{Ltot}$，通过噪声功率
$$N_{tot}=\frac{V_{swing}^2}{2\times10^{\mathrm{DR}/10}}$$
$$C_{Ltot}=\frac{2kT\gamma}{\beta N_{tot}}$$
$$C_L=C_{Ltot}-(1-\beta)C_f$$
在这里会验证$C_L$是否满足$2\upF$的要求。

接下来通过静态误差得到低频增益的要求
$a_v0=\frac{1}{\epsilon_s\beta}$




\subsection{手工调整}

\newpage

\section{电路性能}
环路增益如图

% Page 6: Bode plot of T(j), phase and magnitude. Clearly annotate the achieved 
% low frequency loop gain, the loop crossover frequency and the phase margin.

\newpage

% Page 7: Plots the simulated settling transient of Vod (no zoom, show the 
% entire waveform). In a separate subplot, show the % error of the differential 
% output voltage relative to the ideal output voltage. Zoom into the relevant 
% region of the settling, i.e. clearly demonstrate that your
% design settles within spec. Annotate the achieved settling time and static 
% settling error. For simplicity, we use the error at t=30ns as an estimate of 
% the static settling error.  

\newpage

% Page 8: Plot the common mode output voltage versus time during transient 
% settling of the circuit. In separate subplots each, also show the differential 
% output current of the OTA, and the differential input to the OTA (Vid in Figure 1).

\newpage

% Page 9: Plot of the noise power spectral density at the OTA output (Vod) and 
% noise integral.  Annotate the total integrated noise value and the achieved 
% dynamic range.  

\newpage

% Page 10: Output range. Simulation plot showing the differential open loop DC 
% gain Vod/Vid of the amplifier. Mark the differential output voltage at which 
% the gain has dropped by 30%.  This value should be larger than the peak output 
% voltage used in your dynamic range calculation.

\newpage

% Page 11-12: Results of corner simulations. Tabulate your circuit’s performance 
% for the slow/hot and fast/cold corner. Include settling time, static error, 
% and any other parameter that you find noteworthy. Include the %-changes with 
% respect to nominal conditions in your table.
% In case the circuit is non-functional in these corners, investigate and explain 
% the problem (no need to fix the circuit). Include selected interesting plots 
% documenting corner performance and/or issues.

\newpage

% Page 13: Comments and Conclusion. Here, you can convey issues you may have had, 
% or things you’ve learned/not learned in this project.
\section{结论与总结}


\end{document}
